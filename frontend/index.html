<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒ·ìƒ· (ShotShot)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 2; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(e=>console.log(e));
    </script>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const root = ReactDOM.createRoot(document.getElementById('root'));
        
        // âš ï¸ [ì„¤ì •]
        const API_BASE_URL = 'https://shotshot.onrender.com'; 
        const TEST_USER_ID = '692e612f463ac6f3e8a1ef8c'; 
        const firebaseConfig = {apiKey: "AIzaSyCM2DLvehwPj8m5QEywhreHO2BEojzm7cU", authDomain: "shotshot-95085.firebaseapp.com", databaseURL: "https://shotshot-95085-default-rtdb.firebaseio.com", projectId: "shotshot-95085", storageBucket: "shotshot-95085.firebasestorage.app", messagingSenderId: "938741929966", appId: "1:938741929966:web:02f75fcacb7a10db0520ff" };
        const VAPID_KEY = 'BOfmI4ePJPcDx7MMZjAchBxq3rg5qfc3ed2DTEidAVRFW-sJU3JCOkPd6tOaAVTQNqZiMYGrPGo7qh2FjDRoBzs';

        const requestFCM=async(u)=>{try{const a=!firebase.apps.length?firebase.initializeApp(FIREBASE_CONFIG):firebase.app();const m=firebase.messaging(a);if((await Notification.requestPermission())==='granted'){const t=await m.getToken({vapidKey:VAPID_KEY});if(t){await fetch(`${API_BASE_URL}/api/user/fcm`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u,fcmToken:t})});return true;}}}catch(e){}return false;};
        const Modal=({isOpen,onClose,title,children})=>(!isOpen?null:<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden"><div className="flex justify-between items-center p-4 border-b"><h3 className="text-lg font-bold">{title}</h3><button onClick={onClose}><i className="fas fa-times"></i></button></div><div className="p-4">{children}</div></div></div>);
        const KeywordRegister=({userId})=>{const [k,setK]=useState('');const h=async(e)=>{e.preventDefault();if(!k.trim())return;await fetch(`${API_BASE_URL}/api/keywords`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,keyword:k})});setK('');alert('ë“±ë¡ë¨')};return(<form onSubmit={h} className="flex gap-2"><input value={k} onChange={e=>setK(e.target.value)} className="flex-1 border p-2 rounded" placeholder="í‚¤ì›Œë“œ ì…ë ¥" /><button className="bg-red-500 text-white px-4 rounded">ë“±ë¡</button></form>)};
        const Sidebar=({isOpen,onClose,selected,onSelect})=>{if(!isOpen)return null;const s=[{id:'ppomppu',n:'ë½ë¿Œ',c:'text-purple-600',i:'fas fa-gift'},{id:'fmkorea',n:'í¨ì½”',c:'text-blue-600',i:'fas fa-comment-dollar'},{id:'quasarzone',n:'í€˜ì¡´',c:'text-orange-500',i:'fas fa-microchip'}];return(<div className="fixed inset-0 z-50 flex"><div className="fixed inset-0 bg-black/50" onClick={onClose}></div><div className="relative w-64 bg-white shadow-xl flex flex-col"><div className="p-5 border-b flex justify-between items-center"><h2 className="font-bold">ì‚¬ì´íŠ¸ ì„ íƒ</h2><button onClick={onClose}><i className="fas fa-times"></i></button></div><div className="p-2 space-y-1">{s.map(i=>(<button key={i.id} onClick={()=>{onSelect(i.id);onClose()}} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${selected===i.id?'bg-red-50 border border-red-100':'hover:bg-gray-50'}`}><i className={`${i.i} ${selected===i.id?'text-red-500':'text-gray-400'} w-6`}></i><span className={`font-medium ${selected===i.id?'text-gray-900':'text-gray-500'}`}>{i.n}</span>{selected===i.id&&<i className="fas fa-check text-red-500 ml-auto"></i>}</button>))}</div></div></div>);};

        const DealCard = ({ deal }) => {
            const price = deal.price.match(/[\d,]+/) ? deal.price.match(/[\d,]+/)[0] : deal.price;
            let siteBadge = { color: 'bg-gray-500', name: deal.site };
            if (deal.site === 'ppomppu') siteBadge = { color: 'bg-purple-600', name: 'ë½ë¿Œ' };
            if (deal.site === 'fmkorea') siteBadge = { color: 'bg-blue-600', name: 'í¨ì½”' };
            if (deal.site === 'quasarzone') siteBadge = { color: 'bg-orange-500', name: 'í€˜ì¡´' };

            const timeAgo = (d) => {
                const min = Math.floor((new Date() - new Date(d)) / 60000);
                return min < 60 ? `${min}ë¶„ ì „` : `${Math.floor(min/60)}ì‹œê°„ ì „`;
            };

            return (
                <a href={deal.url} target="_blank" className="group bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 flex flex-col h-full">
                    <div className="relative w-full h-40 bg-gray-100 overflow-hidden">
                        {deal.imageUrl ? (
                            <img src={deal.imageUrl} className="w-full h-full object-cover group-hover:scale-105 transition-transform" onError={(e)=>{e.target.style.display='none';}}/>
                        ) : null}
                        <div className={`absolute inset-0 flex items-center justify-center bg-gray-50 ${deal.imageUrl ? 'hidden' : 'flex'}`}><i className="fas fa-box-open text-4xl text-gray-300"></i></div>
                        <span className={`absolute top-3 left-3 text-[10px] font-bold text-white px-2 py-1 rounded shadow-md ${siteBadge.color}`}>{siteBadge.name}</span>
                    </div>
                    <div className="p-4 flex flex-col flex-1">
                        <div className="flex justify-between items-start mb-2"><span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">{deal.category}</span><span className="text-xs text-gray-400">{timeAgo(deal.postedAt)}</span></div>
                        <h3 className="font-bold text-gray-800 text-sm leading-snug line-clamp-2 mb-3 group-hover:text-red-600 transition-colors">{deal.title}</h3>
                        <div className="mt-auto flex justify-between items-end border-t pt-3 border-gray-50"><span className="font-extrabold text-red-600 text-lg">{price}<span className="text-xs font-normal text-gray-500 ml-1">ì›</span></span><div className="text-xs text-gray-400 flex items-center gap-1"><i className="far fa-comment-dots"></i> {deal.commentCount}</div></div>
                    </div>
                </a>
            );
        };

        const App = () => {
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedSite, setSelectedSite] = useState('ppomppu');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [keywordOpen, setKeywordOpen] = useState(false);
            
            // ğŸš¨ ê²€ìƒ‰ ê´€ë ¨ ìƒíƒœ ì¶”ê°€
            const [isSearchMode, setIsSearchMode] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);

            const loadDeals = useCallback(async () => {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/deals`);
                    const json = await res.json();
                    if(json.success) setDeals(json.deals);
                } catch(e) {} finally { setLoading(false); }
            }, []);

            useEffect(() => { 
                if (TEST_USER_ID !== 'TEST_USER_ID_PLACEHOLDER') { loadDeals(); const i = setInterval(loadDeals, 60000); return () => clearInterval(i); }
            }, [loadDeals]);

            const filtered = useMemo(() => deals.filter(d => d.site === selectedSite), [deals, selectedSite]);
            const siteName = { ppomppu:'ë½ë¿Œ', fmkorea:'í¨ì½”', quasarzone:'í€˜ì´ì‚¬ì¡´' }[selectedSite];

            const toggleNoti = async () => { if (await requestFCM(TEST_USER_ID)) alert('ì•Œë¦¼ ON'); else alert('ê¶Œí•œ í•„ìš”'); };

            // ğŸš¨ ê²€ìƒ‰ í•¸ë“¤ëŸ¬
            const handleSearch = async (e) => {
                e.preventDefault();
                if(!searchQuery.trim()) return;
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/search?q=${encodeURIComponent(searchQuery)}`);
                    const json = await res.json();
                    if(json.success) {
                        setSearchResults(json.deals);
                        setIsSearchMode(true);
                    }
                } catch(e) { alert('ê²€ìƒ‰ ì‹¤íŒ¨'); }
                setLoading(false);
            };

            const closeSearch = () => {
                setIsSearchMode(false);
                setSearchQuery('');
                setSearchResults([]);
                loadDeals(); // ì›ë˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            };

            return (
                <div className="max-w-7xl mx-auto min-h-screen bg-gray-50 pb-20 shadow-xl">
                    <header className="sticky top-0 bg-white/90 backdrop-blur border-b h-16 flex items-center justify-between px-4 z-20">
                        <div className="flex items-center gap-2">
                            <button onClick={()=>setSidebarOpen(true)} className="text-gray-600 p-2 hover:bg-gray-100 rounded-full"><i className="fas fa-bars text-xl"></i></button>
                            {!isSearchMode && (
                                <h1 className="font-black text-red-600 text-2xl tracking-tight flex items-center gap-2 cursor-pointer" onClick={loadDeals}>
                                    <i className="fas fa-bolt"></i>ìƒ·ìƒ· <span className="text-gray-400 font-normal text-sm pt-1 hidden sm:inline">| {siteName}</span>
                                </h1>
                            )}
                        </div>

                        {/* ê²€ìƒ‰ë°” ì˜ì—­ */}
                        <div className={`flex-1 mx-4 max-w-md transition-all duration-300 ${isSearchMode ? 'block' : 'hidden md:block'}`}>
                            <form onSubmit={handleSearch} className="relative">
                                <input 
                                    type="text" 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="ì§€ë‚œ í•«ë”œ ê²€ìƒ‰..." 
                                    className="w-full bg-gray-100 border-none rounded-full py-2 pl-4 pr-10 focus:ring-2 focus:ring-red-500 outline-none text-sm"
                                />
                                {isSearchMode ? (
                                    <button type="button" onClick={closeSearch} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-500">
                                        <i className="fas fa-times"></i>
                                    </button>
                                ) : (
                                    <button type="submit" className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500">
                                        <i className="fas fa-search"></i>
                                    </button>
                                )}
                            </form>
                        </div>

                        <div className="flex gap-1">
                            {/* ëª¨ë°”ì¼ìš© ê²€ìƒ‰ ë²„íŠ¼ í† ê¸€ (í™”ë©´ ì‘ì„ë•Œë§Œ ë³´ì„) */}
                            <button onClick={()=>setIsSearchMode(true)} className={`md:hidden text-gray-600 p-2 hover:bg-gray-100 rounded-full ${isSearchMode ? 'hidden' : 'block'}`}>
                                <i className="fas fa-search text-xl"></i>
                            </button>

                            <button onClick={()=>setKeywordOpen(true)} className="text-gray-600 p-2 hover:text-red-500 hover:bg-gray-100 rounded-full"><i className="fas fa-plus-circle text-xl"></i></button>
                            <button onClick={toggleNoti} className="text-gray-600 p-2 hover:text-blue-500 hover:bg-gray-100 rounded-full"><i className="far fa-bell text-xl"></i></button>
                        </div>
                    </header>

                    <main className="p-4 md:p-6 lg:p-8">
                        {isSearchMode && (
                            <div className="mb-4 flex items-center justify-between">
                                <h2 className="font-bold text-xl text-gray-800">ğŸ” '{searchQuery}' ê²€ìƒ‰ ê²°ê³¼</h2>
                                <button onClick={closeSearch} className="text-sm text-red-500 font-bold hover:underline">ë‹«ê¸°</button>
                            </div>
                        )}

                        {loading ? (
                            <div className="text-center py-20 text-gray-400"><i className="fas fa-circle-notch fa-spin text-3xl mb-4"></i><p>ë¡œë”© ì¤‘...</p></div>
                        ) : (isSearchMode ? searchResults : filtered).length === 0 ? (
                            <div className="text-center py-20 text-gray-400">
                                <i className="far fa-folder-open text-4xl mb-2"></i>
                                <p>{isSearchMode ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤." : `${siteName} í•«ë”œì´ ì—†ìŠµë‹ˆë‹¤.`}</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {(isSearchMode ? searchResults : filtered).map(d => <DealCard key={d._id} deal={d} />)}
                            </div>
                        )}
                    </main>

                    <Sidebar isOpen={sidebarOpen} onClose={()=>setSidebarOpen(false)} selected={selectedSite} onSelect={setSelectedSite} />
                    <Modal isOpen={keywordOpen} onClose={()=>setKeywordOpen(false)} title="í‚¤ì›Œë“œ ì•Œë¦¼"><KeywordRegister userId={TEST_USER_ID} /></Modal>
                </div>
            );
        };
        root.render(<App />);
    </script>
</body>
</html>