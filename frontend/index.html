<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒ·ìƒ·</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font Awesome ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ğŸš¨ Firebase SDK (App, Messaging) CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>
    
    <!-- ğŸš¨ Service Worker ë“±ë¡: ì‹¤ì œ ë°°í¬ ì‹œ firebase-messaging-sw.js íŒŒì¼ì´ ë£¨íŠ¸ì— ìˆì–´ì•¼ í•¨ -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then(registration => {
                    console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration);
                })
                .catch(error => {
                    console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                });
        }
    </script>

    <!-- ğŸš¨ í•µì‹¬: App ì»´í¬ë„ŒíŠ¸ì™€ FCM ë¡œì§ -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const root = ReactDOM.createRoot(document.getElementById('root'));
        
        const API_BASE_URL = 'https://shotshot.onrender.com';

        // âš ï¸ 1. ì‹¤ì œ ì‚¬ìš©ì IDë¡œ êµì²´í•˜ì„¸ìš”. (ë°±ì—”ë“œ ë¡œê·¸ì—ì„œ í™•ì¸)
        const TEST_USER_ID = '692e612f463ac6f3e8a1ef8c'; 

        // âš ï¸ 2. ì‹¤ì œ Firebase ì„¤ì • ê°ì²´ë¡œ êµì²´í•˜ì„¸ìš”.
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCM2DLvehwPj8m5QEywhreHO2BEojzm7cU",
            authDomain: "shotshot-95085.firebaseapp.com",
            projectId: "shotshot-95085",
            storageBucket: "shotshot-95085.firebasestorage.app",
            messagingSenderId: "938741929966",
            appId: "1:938741929966:web:02f75fcacb7a10db0520ff",
        };
        
        // âš ï¸ 3. ì‹¤ì œ VAPID í‚¤ ë¬¸ìì—´ë¡œ êµì²´í•˜ì„¸ìš”.
        const vapidKey = 'BOfmI4ePJPcDx7MMZjAchBxq3rg5qfc3ed2DTEidAVRFW-sJU3JCOkPd6tOaAVTQNqZiMYGrPGo7qh2FjDRoBzs'; 


        // Firebase ì´ˆê¸°í™” ë° í† í° ìš”ì²­ ë¡œì§
        const requestFCMToken = async (userId) => {
            if (userId === 'TEST_USER_ID_PLACEHOLDER') return false;

            try {
                // ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì´ˆê¸°í™”
                const firebaseApp = !firebase.apps.length 
                    ? firebase.initializeApp(FIREBASE_CONFIG) 
                    : firebase.app();
                
                const messaging = firebase.messaging(firebaseApp);
                
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('ì•Œë¦¼ ê¶Œí•œ íšë“.');
                    
                    const currentToken = await messaging.getToken({ vapidKey: vapidKey });

                    if (currentToken) {
                        console.log('FCM í† í° íšë“:', currentToken.substring(0, 10) + '...');
                        
                        await fetch(`${API_BASE_URL}/api/user/fcm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: userId, fcmToken: currentToken })
                        });
                        console.log('FCM í† í°ì´ ë°±ì—”ë“œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        return true;
                    } else {
                        console.warn('FCM í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return false;
                    }
                } else {
                    console.warn('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return false;
                }
            } catch (error) {
                console.error('FCM ì„¤ì • ì˜¤ë¥˜:', error);
                return false;
            }
        };


        // ì»´í¬ë„ŒíŠ¸: í•«ë”œ ì¹´ë“œ
        const DealCard = ({ deal }) => {
            const priceMatch = deal.price.match(/[\d,]+/);
            const displayedPrice = priceMatch ? priceMatch[0] : deal.price;
            
            let siteColor = 'bg-gray-500';
            if (deal.site === 'ppomppu') siteColor = 'bg-blue-600';
            else if (deal.site === 'quasarzone') siteColor = 'bg-green-600';

            const formatTime = (isoString) => {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            return (
                <a href={deal.url} target="_blank" rel="noopener noreferrer" 
                   className="block bg-white rounded-xl shadow-md hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-gray-100 group cursor-pointer">
                    <div className="h-40 bg-gray-50 relative overflow-hidden flex items-center justify-center p-4">
                        <div className="absolute top-3 left-3">
                            <span className={`${siteColor} text-white text-xs font-bold px-2 py-1 rounded shadow-sm capitalize`}>
                                {deal.site}
                            </span>
                        </div>
                        <i className="fas fa-box text-5xl text-gray-300"></i>
                    </div>
                    <div className="p-4">
                        <div className="text-xs text-gray-500 mb-1 flex justify-between items-center">
                            <span>{deal.category}</span>
                            <span>{formatTime(deal.postedAt)}</span>
                        </div>
                        <h3 className="font-bold text-gray-900 mb-2 line-clamp-2 leading-tight group-hover:text-red-500 transition-colors">
                            {deal.title}
                        </h3>
                        <div className="flex items-end justify-between mt-3">
                            <div className="text-lg font-extrabold text-red-600">{displayedPrice}ì›</div>
                            <div className="flex items-center space-x-3 text-sm text-gray-500">
                                <span><i className="far fa-comment"></i> {deal.commentCount}</span>
                            </div>
                        </div>
                    </div>
                </a>
            );
        };

        // ì»´í¬ë„ŒíŠ¸: í‚¤ì›Œë“œ ë“±ë¡ í¼
        const KeywordForm = ({ userId }) => {
            const [keyword, setKeyword] = useState('');
            const [message, setMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!keyword.trim()) return;

                setIsLoading(true);
                setMessage('');

                try {
                    const response = await fetch(`${API_BASE_URL}/api/keywords`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, keyword: keyword.trim() })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        setMessage({ type: 'success', text: data.message });
                        setKeyword('');
                    } else {
                        setMessage({ type: 'error', text: data.message || 'ì‹¤íŒ¨' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨' });
                } finally {
                    setIsLoading(false);
                    setTimeout(() => setMessage(''), 5000); 
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl font-bold mb-4 text-gray-800 flex items-center">
                        <i className="fas fa-bell mr-2 text-red-500"></i> ì•Œë¦¼ í‚¤ì›Œë“œ ë“±ë¡
                    </h2>
                    <p className="text-sm text-gray-600 mb-4">
                        ë“±ë¡ëœ í‚¤ì›Œë“œê°€ í¬í•¨ëœ í•«ë”œì´ ëœ¨ë©´ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
                    </p>
                    <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row gap-3">
                        <input type="text" value={keyword} onChange={(e) => setKeyword(e.target.value)}
                            placeholder="ì˜ˆ: ë‚˜ì´í‚¤, 4070"
                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500"
                            disabled={isLoading} />
                        <button type="submit"
                            className="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg disabled:opacity-50"
                            disabled={isLoading || userId === 'TEST_USER_ID_PLACEHOLDER'}>
                            {isLoading ? 'ë“±ë¡ ì¤‘...' : 'ë“±ë¡'}
                        </button>
                    </form>
                    {message && (
                        <p className={`mt-3 text-sm font-medium ${message.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>
                            {message.text}
                        </p>
                    )}
                </div>
            );
        };

        // ë©”ì¸ App ì»´í¬ë„ŒíŠ¸
        const App = () => {
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [fcmStatus, setFcmStatus] = useState('ëŒ€ê¸° ì¤‘');

            const fetchDeals = useCallback(async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/deals`);
                    const data = await response.json();
                    if (data.success) setDeals(data.deals);
                    else setError(data.message);
                } catch (err) {
                    console.error(err);
                    setError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (URL í™•ì¸ í•„ìš”)');
                } finally {
                    setLoading(false);
                }
            }, []);
            
            // ë°ì´í„° ë¡œë“œ
            useEffect(() => {
                if (TEST_USER_ID === 'TEST_USER_ID_PLACEHOLDER') {
                    setLoading(false);
                    setError('index.html íŒŒì¼ì„ ì—´ì–´ TEST_USER_IDì™€ API_BASE_URLì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.');
                    return;
                }
                fetchDeals();
                const interval = setInterval(fetchDeals, 60000); 
                return () => clearInterval(interval);
            }, [fetchDeals]);
            
            // FCM í† í° ìš”ì²­
            useEffect(() => {
                if (TEST_USER_ID !== 'TEST_USER_ID_PLACEHOLDER') {
                    setFcmStatus('ìš”ì²­ ì¤‘...');
                    requestFCMToken(TEST_USER_ID)
                        .then(success => setFcmStatus(success ? 'âœ… ì•Œë¦¼ ì¼œì§' : 'âš ï¸ ì•Œë¦¼ ì‹¤íŒ¨'))
                        .catch(() => setFcmStatus('âŒ ì˜¤ë¥˜'));
                }
            }, []);

            return (
                <div className="min-h-screen bg-gray-100 font-sans pb-10">
                    <header className="bg-red-600 text-white p-4 shadow-xl sticky top-0 z-10">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-3xl font-black flex items-center gap-2">
                                <i className="fas fa-fire"></i> í•«ë”œ-ëª¨ì•„
                            </h1>
                            <div className="flex items-center space-x-4">
                                <span className="text-xs bg-white text-red-600 px-2 py-1 rounded font-bold">
                                    {fcmStatus}
                                </span>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 md:p-8">
                        <section className="mb-8">
                            <KeywordForm userId={TEST_USER_ID} />
                        </section>

                        <section>
                            <h2 className="text-2xl font-bold mb-6 text-gray-800 border-b-2 pb-2 border-red-500">
                                ğŸ”¥ ìµœì‹  í•«ë”œ
                            </h2>
                            {loading && <div className="text-center py-12 text-gray-600"><i className="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>}
                            {error && <div className="bg-red-100 text-red-700 p-4 rounded mb-4 font-bold">{error}</div>}
                            
                            {!loading && !error && (
                                deals.length > 0 ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {deals.map(deal => <DealCard key={deal._id} deal={deal} />)}
                                    </div>
                                ) : (
                                    <div className="text-center py-12 text-gray-500">ìˆ˜ì§‘ëœ í•«ë”œì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                )
                            )}
                        </section>
                    </main>
                    
                    <footer className="text-center text-gray-400 text-sm mt-8">
                        Hotdeal-Moa Project
                    </footer>
                </div>
            );
        };
        
        root.render(React.createElement(App));
    </script>
</body>
</html>